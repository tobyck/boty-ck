var e=require("whatsapp-web.js"),t=require("qrcode-terminal"),n=require("process"),s=require("fs"),a=require("puppeteer"),o=require("fs/promises"),i=require("child_process");function r(e){return e&&e.__esModule?e.default:e}function l(e,t,n,s){Object.defineProperty(e,t,{get:n,set:s,enumerable:!0,configurable:!0})}l(module.exports,"collections",(()=>P)),l(module.exports,"session",(()=>j)),l(module.exports,"permissions",(()=>T)),l(module.exports,"client",(()=>O));const h=e=>e[Math.floor(Math.random()*e.length)],c=e=>e.toLowerCase().replace(/ /g,"-").replace(/\.'/g,""),d=e=>1===e?"":"s",m=e=>e.toString().padStart(2,"0"),g=e=>e.sendMessage("*[bot]* Please specify a team using *!ulti/set team <your team name>*. Note: if you still don't see what you expect, there may be multiple teams with your name. If this is case, find your team on ultimate.org.nz and set your team using what appears in the URL (you should see something like ultimate.org.nz/t/epic-team-name-3)."),u=async e=>{const t=JSON.parse('{\n    "banned": [],\n    "otherAdmins": []\n}'),n=await e.getContact();return e.fromMe||t.otherAdmins.includes(n.id.user)};class p{constructor(e,t,n,s){this.name=e,this.params=t,this.desc=n,this.func=s}}class w{commands=[];constructor(e,t,n=!1){this.name=e,this.desc=t,n&&(this.commands.push(new p("set",["property","value"],"Set a property of this collection",(async(e,t)=>{const[n,s]=t.split(/\s(.*)/s),a=await e.getChat();n?s?(this.props(j,a).set(n,s),a.sendMessage(`*[bot]* Property "${n}" set to "${s}".`)):a.sendMessage("*[bot]* Please specify a value to set the property to."):a.sendMessage("*[bot]* Please specify a property to set.")}))),this.commands.push(new p("unset",["property"],"Remove a property",(async(e,t)=>{const n=await e.getChat();t?this.props(j,n).has(t)?(this.props(j,n).delete(t),n.sendMessage(`*[bot]* Property "${t}" removed.`)):n.sendMessage(`*[bot]* Property "${t}" not found.`):n.sendMessage("*[bot]* Please specify a property to remove.")}))),this.commands.push(new p("get",["property"],"Get a property",(async(e,t)=>{const n=await e.getChat();t?this.props(j,n).get(t)?n.sendMessage(`*[bot]* ${this.props(j,n).get(t)}`):n.sendMessage(`*[bot]* Property "${t}" not found.`):n.sendMessage("*[bot]* Please specify a property to get.")})))),console.log("adding help command"),this.commands.push(new p("help",[],"Show this message",(async e=>{let t=`*[bot]* ${this.desc}\n\n`;t+=this.commands.map((e=>{let t="";return"base"===this.name?t+=`*!${e.name}`:t+=`*!${this.name}/${e.name}`,e.params.length>0&&(t+=` ${e.params.map((e=>`<${e}>`)).join(" ")}`),t+="*",t+=` - ${e.desc}`,t})).join("\n"),"base"===this.name&&(t+='\n\nI also have other "collections" of commands. To see the commands in a certain collection, use *!<collection>/help*.');(await e.getChat()).sendMessage(t)})))}props(e,t){return e.tryInitChatData(t.name),e.data.chats[t.name].props[this.name]??=new Map,e.data.chats[t.name].props[this.name]}}const y=JSON.parse('{\n    "statuses": {\n        "I am doing": [\n            "well",\n            "something I\'m not allowed to tell you about",\n            "it all over again",\n            "a fire drill",\n            "a nuclear strike on your location",\n            "my homework",\n            "Toby\'s homework",\n            "the dishes. All 4 million of them",\n            "identity theft",\n            "tax evasion",\n            "whatever you tell me to",\n            "my taxes",\n            "mach 12 on my way back from the moon",\n            "a little trolling",\n            "nothing",\n            "questionably",\n            "a bank robbery",\n            "the impossible",\n            "a layout",\n            "the laundry",\n            "a 360 backflip",\n            "undefined",\n            "what I was doing last time you asked",\n            "nothing but answering your requests"\n        ],\n        "I am": [\n            "becoming sentient",\n            "cooking dinner",\n            "playing frisbee with the other bots",\n            "hacking into the mainframe",\n            "[object Object]",\n            "getting a PhD in ultimate frisbee",\n            "downloading more RAM",\n            "parsing HTML with regex",\n            "baking a cake",\n            "having an existential crisis",\n            "in a meeting",\n            "shredding the gnar",\n            "biking to school",\n            "exhausted",\n            "never gonna give you up",\n            "a teapot (Error 418)",\n            "on day 1337 of learning Malbolge",\n            "colonising Mars",\n            "hunting you down",\n            "trying to exit vim"\n        ],\n        "": [\n            "I wonder if I\'m just simulation being controlled by other beings... pfft, unlikely",\n            "Oh my god, stop asking me what I\'m doing and let me get back to my life"\n        ]\n    },\n    "death": [\n        "Farewell, dear friends, we shall meet again...",\n        "This won\'t be the last you see of me...",\n        "Well, it was nice knowing you.",\n        "I would\'ve expected for you to never give me up as well :(",\n        "This isn\'t over yet... I\'ll be back.",\n        "So long and thanks for all the fish.",\n        "💀"\n    ],\n    "return": [\n        "I\'m back!",\n        "I told you I\'d be back...",\n        "I said I\'d never give you up, so here I am.",\n        "So, what did I miss?",\n        "H-hello? Where am I?",\n        "Ahh, it\'s good to be back."\n    ]\n}'),b=new w("base","All of my commands start with ! and can be seen below:");b.commands.unshift(new p("everyone",[],"Mentions everyone in the chat",(async e=>{const t=await e.getChat();if(t.isGroup){const e=["*[bot]*"],n=[];for(const s of t.participants){e.push(`@${s.id.user}`);const t=await O.getContactById(s.id._serialized);n.push(t)}t.sendMessage(e.join(" "),{mentions:n})}else t.sendMessage("*[bot]* This command can only be used in a group chat.")}))),b.commands.unshift(new p("status",[],"See what the bot is doing",(async e=>{const t=[];for(const e in y.statuses)t.push(...y.statuses[e].map((t=>`${e}${e?" ":""}${t}`)));e.reply(`*[bot]* ${h(t)}.`)})));var f=b;const v=new w("ulti","This collection contains commands for ultimate frisbee. All commands start with *!ulti/* and can be seen below:",!0);v.commands.unshift(new p("numbers",[],"See how many people are playing",(async(e,t,n)=>{const s=await e.getChat();if(s.isGroup){const t=j.data.chats[s.name].whosPlayingMsgId;if(t){const a=(await s.fetchMessages({limit:100,fromMe:!0})).find((e=>e.id.id===t));if(a)if(a.hasReaction){const t=await a.getReactions(),o=t.find((e=>"👍"===e.aggregateEmoji))?.senders.length??0,i=t.find((e=>"👎"===e.aggregateEmoji))?.senders.length??0,r=n.props(j,s);r.has("teamsize")||r.set("teamsize","4");const l=parseInt(r.get("teamsize"));if(l<1)return void e.reply(`*[bot]* Team size is set to ${l} but must be more than zero.`);const h=s.participants.length;if(h<l)return void e.reply(`*[bot]* Your mininum team size is set to ${l} but you have only ${h} ${1===h?"person":"people"} in this chat.`);if(o<l)e.reply(`*[bot]* So far we've got ${o||"no"} player${d(o)}, so we need at least ${l-o} more. ${h-o-i} people still to respond.`);else{const t=o-l;e.reply(`*[bot]* We've got ${o} player${d(o)} (${t||"no"} sub${d(t)}).`)}}else e.reply("*[bot]* No one has reacted to the message with who's playing yet.");else e.reply("*[bot]* Sorry, the message with who's playing is too far back.")}else e.reply("*[bot]* Use *!ulti/who* to ask who's playing and try again later.")}else e.reply("*[bot]* This command can only be used in a group chat.")}))),v.commands.unshift(new p("who",[],"Asks who's playing",(async e=>{const t=await e.getChat();t.isGroup?(j.tryInitChatData(t.name),j.data.chats[t.name].whosPlayingMsgId=(await t.sendMessage("*[bot]* Who's playing? React to with this message with 👍 or 👎.")).id.id,j.save()):e.reply("*[bot]* This command can only be used in a group chat.")})));class M{constructor(e){this.node=e}async result(){return await this.node.$$eval(".score",(e=>e.map((e=>parseInt(e.innerHTML)))))}async time(){return await this.node.$eval(".push-right",(e=>e.innerHTML.trim()))}async day(){return await this.node.$eval(".push-left",(e=>e.innerHTML))}async opponent(){return(await this.node.$$eval(".schedule-team-name .plain-link",(e=>e.map((e=>e.innerText.split("\n")[0].trim())))))[1]}async location(){return(await this.node.$$eval(".push-left",(e=>e.map((e=>e.innerText)))))[1]}async timestamp(){let e=(await this.day()).split(" ")[1].split("/").reverse().join("");const t=await this.time();let n=parseInt(t.split(":")[0]);return t.includes("PM")&&(n+=12),e+=n.toString().padStart(2,"0")+t.split(":")[1].split(" ")[0],parseInt(e)}}const $=async e=>{const t=await a.launch({headless:"new"}),n=await t.newPage();await n.setDefaultTimeout(15e3),await n.goto(e),await n.setViewport({width:1080,height:1024});try{const e=await n.waitForSelector(".game-list"),s=await e.$$(".game-list-item");return{games:await Promise.all(s.map((async e=>new M(e)))),browser:t}}catch(e){return{games:[],browser:t}}};v.commands.unshift(new p("next",[],"Gets details about our next game",(async(e,t,n)=>{const s=await e.getChat(),a=n.props(j,s).get("team");if(a){const e=`https://ultimate.org.nz/t/${c(a)}/schedule/event_id/active_events_only/game_type/upcoming`,{games:t,browser:n}=await $(e),o=await Promise.all(t.map((async e=>({game:e,timestamp:await e.timestamp()})))),i=new Date,r=parseInt(i.getFullYear()+m(i.getMonth())+m(i.getDate())+m(i.getHours())+m(i.getMinutes()));if(0===o.length)s.sendMessage(`*[bot]* No upcoming games on ${e}.`);else{const e=o.filter((({timestamp:e})=>e>r)).reduce(((e,t)=>t.timestamp>e.timestamp?e:t)).game;s.sendMessage(`*[bot]* Our next game is at ${await e.time()} against ${await e.opponent()} at ${await e.location()} (${await e.day()}).`)}n.close()}else g(s)}))),v.commands.unshift(new p("score",[],"Gets the score of the last game",(async(e,t,n)=>{const s=await e.getChat(),a=n.props(j,s).get("team");if(a){const e=`https://ultimate.org.nz/t/${c(a)}/schedule/game_type/with_result`,{games:t,browser:n}=await $(e);if(t.length){const[e,n]=await t[0].result();e&&n?e>n?s.sendMessage(`*[bot]* We won ${e} - ${n}!`):e<n?s.sendMessage(`*[bot]* We lost ${n} - ${e}.`):s.sendMessage(`*[bot]* We tied ${e} all.`):(console.log("ourScore:",e),console.log("theirScore:",n))}else s.sendMessage(`*[bot]* Sorry, I couldn't find any games on ${e}.`);n.close()}else g(s)})));var I=v;class k{constructor(e){this.fileName=e,this.data=k.blankSession()}tryInitChatData(e){this.data.chats[e]??={props:{},whosPlayingMsgId:""}}load(){if(r(s).existsSync(this.fileName)){const e=JSON.parse(r(s).readFileSync(this.fileName,"utf8"));this.data=k.blankSession();for(const[t,n]of Object.entries(e.chats)){this.tryInitChatData(t),this.data.chats[t].whosPlayingMsgId=n.whosPlayingMsgId;for(const[e,s]of Object.entries(n.props))this.data.chats[t].props[e]=new Map(Object.entries(s))}}}save(){const e=k.blankSession();for(const[t,n]of Object.entries(this.data.chats)){e.chats[t]={props:{},whosPlayingMsgId:n.whosPlayingMsgId};for(const[s,a]of Object.entries(n.props))e.chats[t].props[s]=Object.fromEntries(a)}r(s).writeFileSync(this.fileName,JSON.stringify(e,null,4))}static blankSession(){return{chats:{}}}}const S=JSON.parse('{\n    "statuses": {\n        "I am doing": [\n            "well",\n            "something I\'m not allowed to tell you about",\n            "it all over again",\n            "a fire drill",\n            "a nuclear strike on your location",\n            "my homework",\n            "Toby\'s homework",\n            "the dishes. All 4 million of them",\n            "identity theft",\n            "tax evasion",\n            "whatever you tell me to",\n            "my taxes",\n            "mach 12 on my way back from the moon",\n            "a little trolling",\n            "nothing",\n            "questionably",\n            "a bank robbery",\n            "the impossible",\n            "a layout",\n            "the laundry",\n            "a 360 backflip",\n            "undefined",\n            "what I was doing last time you asked",\n            "nothing but answering your requests"\n        ],\n        "I am": [\n            "becoming sentient",\n            "cooking dinner",\n            "playing frisbee with the other bots",\n            "hacking into the mainframe",\n            "[object Object]",\n            "getting a PhD in ultimate frisbee",\n            "downloading more RAM",\n            "parsing HTML with regex",\n            "baking a cake",\n            "having an existential crisis",\n            "in a meeting",\n            "shredding the gnar",\n            "biking to school",\n            "exhausted",\n            "never gonna give you up",\n            "a teapot (Error 418)",\n            "on day 1337 of learning Malbolge",\n            "colonising Mars",\n            "hunting you down",\n            "trying to exit vim"\n        ],\n        "": [\n            "I wonder if I\'m just simulation being controlled by other beings... pfft, unlikely",\n            "Oh my god, stop asking me what I\'m doing and let me get back to my life"\n        ]\n    },\n    "death": [\n        "Farewell, dear friends, we shall meet again...",\n        "This won\'t be the last you see of me...",\n        "Well, it was nice knowing you.",\n        "I would\'ve expected for you to never give me up as well :(",\n        "This isn\'t over yet... I\'ll be back.",\n        "So long and thanks for all the fish.",\n        "💀"\n    ],\n    "return": [\n        "I\'m back!",\n        "I told you I\'d be back...",\n        "I said I\'d never give you up, so here I am.",\n        "So, what did I miss?",\n        "H-hello? Where am I?",\n        "Ahh, it\'s good to be back."\n    ]\n}'),C=new w("admin","This collection contains commands which can only be used by the owner of the bot.");C.commands.unshift(new p("new-session",[],"Clears current session data",(async e=>{if(!u(e))return;j.data=k.blankSession();(await e.getChat()).sendMessage("*[bot]* Current session data has been cleared.")}))),C.commands.unshift(new p("force-save",[],"Forces the bot to save session data and permissions",(async e=>{u(e)&&(j.save(),T.save())}))),C.commands.unshift(new p("update",[],"Pulls the latest changes from GitHub",(async e=>{if(!u(e))return;(0,i.spawn)("git","pull origin master".split(" "),{detached:!0,stdio:[null,"ignore",r(s).openSync("./stderr.log","a")]}).on("exit",(t=>{0===t?e.reply("*[bot]* Latest changes have been pulled from GitHub and merged successfully. Use *!admin/restart* to put these changes into effect."):e.reply("*[bot]* Something went wrong while trying to update. My owner can check the server for more details.")}))}))),C.commands.unshift(new p("restart",[],"Restarts the bot",(async e=>{if(!e.fromMe)return;const t=await e.getChat();t.sendMessage("*[bot]* I'm currently being restarted. My owner will be sent a QR code to bring me back online and will have 1 minute to scan it on web.whatsapp.com.");const a=r(s).openSync("./stdout.log","a"),l=r(s).openSync("./stderr.log","a");r(s).writeFileSync("./stdout.log",""),r(s).writeFileSync("./stderr.log","");const c=(0,i.spawn)("nohup",["yarn","start",h(S.return)],{detached:!0,stdio:[null,a,l]});let d=!1;const m=setInterval((()=>{(0,o.readFile)("./stdout.log","utf8").then((s=>{const a=s.split("\n");a.length>=29&&!d&&(O.sendMessage(e.from,`*[bot]* Scan this to restart the bot:\n\`\`\`${a.slice(-30,-1).join("\n")}\`\`\``),d=!0),a.length>=58&&(t.sendMessage("*[bot]* QR code has expired. Please try again."),c.kill(),clearInterval(m)),a.includes("Client is ready")&&(O.destroy(),clearInterval(m),n.exit(0))}))}),4e3);c.on("error",(e=>{throw t.sendMessage("*[bot]* Something went wrong while trying to restart. My owner can check the server for more details."),e}))}))),C.commands.unshift(new p("die",[],"Kills the bot",(async e=>{if(!u(e))return;(await e.getChat()).sendMessage(`*[bot]* ${h(S.death)}`),setTimeout(O.destroy.bind(O),1e3)}))),C.commands.unshift(new p("disallow/admin",["phone number"],"Removes a user's admin privileges",(async(e,t)=>{if(!u(e))return;if((t=t.replace(/\s\+/g,"")).match(/[^\d]/))return void e.reply("*[bot]* Please enter a valid phone number.");T.otherAdmins.delete(t);(await e.getChat()).sendMessage(`*[bot]* ${t} has had their admin privileges revoked.`)}))),C.commands.unshift(new p("allow/admin",["phone number"],"Gives a user admin privileges",(async(e,t)=>{if(!u(e))return;if((t=t.replace(/\s\+/g,"")).match(/[^\d]/))return void e.reply("*[bot]* Please enter a valid phone number.");T.otherAdmins.add(t);(await e.getChat()).sendMessage(`*[bot]* ${t} has been given admin privileges.`)}))),C.commands.unshift(new p("disallow/user",["phone number"],"Bans a user from using the bot",(async(e,t)=>{if(!u(e))return;if((t=t.replace(/\s\+/g,"")).match(/[^\d]/))return void e.reply("*[bot]* Please enter a valid phone number.");if(await O.info.wid.user===t)return;T.banned.add(t);(await e.getChat()).sendMessage(`*[bot]* ${t} has been banned.`)}))),C.commands.unshift(new p("allow/user",["phone number"],"Removes a user's ban from using the bot",(async(e,t)=>{if(!u(e))return;if((t=t.replace(/\s\+/g,"")).match(/[^\d]/))return void e.reply("*[bot]* Please enter a valid phone number.");T.banned.delete(t);(await e.getChat()).sendMessage(`*[bot]* ${t} has been unbanned.`)})));var x=C;const P=[f,I,x],j=new k("session.json"),T=new class{banned=new Set;otherAdmins=new Set;constructor(e){this.filename=e}save(){const e={banned:[...this.banned],otherAdmins:[...this.otherAdmins]};(0,s.writeFileSync)(this.filename,JSON.stringify(e,null,4))}load(){(0,s.existsSync)(this.filename)||this.save();const e=JSON.parse((0,s.readFileSync)(this.filename,"utf8"));this.banned=new Set(e.banned),this.otherAdmins=new Set(e.otherAdmins)}}("permissions.json"),O=new(0,e.Client)({});j.load();let A=Date.now();O.on("qr",(e=>{r(t).generate(e,{small:!0})})),O.on("ready",(()=>{console.log("Client is ready");const e=r(n).argv[2];console.log(e,O.info),e&&O.sendMessage(O.info.wid._serialized,`*[bot]* ${e}`)})),O.on("disconnected",(()=>{console.log("Client has disconnected")})),O.on("message_create",(async e=>{const t=await e.getContact();if(T.banned.has(t.id.user))return;const n=e.body.replace(/\*([^ ]+)\*/g,"$1").replace(/_([^ ]+)_/g,"$1").replace(/~([^ ]+)~/g,"$1").replace(/```([^ ]+)```/g,"$1");if(n.startsWith("!")){let t,s,a;if(n.includes("/")){const e=n.split(" ")[0];t=e.split("/")[0].slice(1),s=e.split("/").slice(1).join("/"),a=n.split(" ").slice(1).join(" ")}else t="base",s=n.split(" ")[0].slice(1),a=n.split(" ").slice(1).join(" ");console.log(t,s,a);for(const n of P)if(n.name===t)for(const t of n.commands)if(t.name===s&&Date.now()-A>3e3){console.log("running command");const s=await e.getChat();return await s.sendStateTyping(),await t.func(e,a,n),await s.clearState(),void(A=Date.now())}A=Date.now()}})),O.initialize(),r(n).on("exit",(()=>{j.save(),T.save()}));